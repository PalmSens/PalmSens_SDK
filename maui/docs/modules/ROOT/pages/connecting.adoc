== Connecting and Measuring

The following chapter details how to connect to a device, read data from
the device, manually controlling the potential, run measurements on the
device and finally how to properly close a connection to a device.

=== Connecting to a device

The following example shows how to get a list of all available devices
and available serial com ports, and how to connect to one of the
discovered devices that.

*Simplified PalmSens.Core:*

using PalmSens.Devices;

Add this namespace at the top of the document.

Device[] devices = psCommSimpleWinForms.ConnectedDevices;

psCommSimpleWinForms.Connect(devices[0]);

The first line returns an array of all the connected devices, and the
second connects to the first device in the array of connected devices.
When Bluetooth devices should also be discovered set
*psCommSimpleWinForms.EnableBluetooth = true* first.

*PalmSens.Core:*

using PalmSens.Comm;

using PalmSens.Devices;

using PalmSens.Windows.Devices;

Add these namespaces at the top of the document.

//List of discover functions

List<DeviceList.DiscoverDevicesFunc> discFuncs = new
List<DeviceList.DiscoverDevicesFunc>();

Create an empty list of device discovery functions.

discFuncs.Add(USBCDCDevice.DiscoverDevices); //Default for PS4

discFuncs.Add(FTDIDevice.DiscoverDevices); //Default for Emstat + PS3

discFuncs.Add(SerialPortDevice.DiscoverDevices); //Devices connected via
serial port

discFuncs.Add(BluetoothDevice.DiscoverDevices); //Bluetooth devices
(PS4, PS3, Emstat Blue)

Add the discovery functions for the types of devices you would like to
discover.

string errors;

Device[] devices = new DeviceList(discFuncs).GetAvailableDevices(out
errors);

The GetAvailableDevices() method has an additional optional parameter
which must be set to true when Bluetooth devices should be included in
the search.

try

\{

device.Open(); //Open the device to allow a connection

comm = new CommManager(devices[0]); //Connect to the device

}

catch (Exception ex)

\{

device.Close();

}

To prevent your program from crashing it is recommended to use a try
catch sequence when connecting to a device, this way a device will be
closed again when an exception occurs. This code will connect to the
first device in the array of discovered devices.

____
*Async functionality*

When using the async commands without the simplified core wrappers you
will need to initiate the synchronization context remover, it is
recommended to set the argument one lower than the amount of logical
processor cores the CPU has unless it has a single core, for example:

var nCores = Environment.ProcessorCount; +
SynchronizationContextRemover.Init(nCores > 1 ? nCores - 1 : 1);

*Bluetooth*

Discovery of Bluetooth devices is disabled by default, it can be enabled
by setting the EnableBluetooth proprety to true. +
 +
psCommSimpleWinForms.EnableBluetooth = true;

To be able to use Bluetooth in your project you should reference the
32.Feet.NET NuGet package in your project
(https://www.nuget.org/packages/32feet.NET/). Bluetooth Classic works on
all supported platforms (Windows 7 SP1, Windows 8.1 and Windows 10).

Bluetooth Low energy only works on Windows 10. To enable Bluetooth Low
Energy you should add references to the *PalmSens.Core.Windows.BLE.dll*
library (included in the PSLibraries folder) in *your* project and the
*PalmSens.Core.Simplified.WinForms* project. Finally, you will also need
to respectively uncomment the following lines in the *ScanDevices* and
the *ScanDevicesAsync* methods of the *DeviceHandler* class in the
*PalmSens.Core.Simplified.WinForms* project. +
 +
discFuncs.Add(BLEDevice.DiscoverDevices);

discFuncs.Add(BLEDevice.DiscoverDevicesAsync());
____

=== Receive idle status readings

The readings of PalmSens can be read continuously using the
*ReceiveStatus* event. The following information can be found in the
*status* object that is received using this event:

* AuxInput (auxiliary input in V, *Status.GetExtraValueAsAuxVoltage()*)
* Current (in uA, *Status.CurrentReading.Value* or
*Status.CurrentReading.ValueInRange*)
* Current2 (in uA, in case a BiPot is used,
*Status.GetExtraValueAsBiPotCurrent()*)
* Noise (*Status.Noise*)
* CurrentRange (the current range in use at the moment,
*Status.CurrentReading.CurrentRange*)
* CurrentStatus (as *PalmSens.Comm.ReadingStatus* is ok, underload or
overload, *Status.CurrentReading.ReadingStatus*)
* Potential (measured potential, *Status.PotentialReading.Value*)
* ReverseCurrent (the reverse current for SquareWave,
*Status.ExtraValue*)
* PretreatmentPhaseStatus (None, Conditioning, Depositing or
Equilibrating, *Status.PretreatmentPhase*)
* VoltageStatus (as *PalmSens.Comm.ReadingStatus* is ok, underload or
overload, *Status.PotentialReading.ReadingStatus*)

*Simplified PalmSens.Core:*

psCommSimpleWinForms.ReceiveStatus +=
PsCommSimpleWinForms_ReceiveStatus;

image:media/image9.png[media/image9,width=189,height=82]Either subscribe
to the ReceiveStatus event of the psCommSimpleWinForms component via the
designer or programmatically. It is not required to be connected to a
device first.

private void psCommSimpleWinForms_ReceiveStatus(object sender,
PalmSens.Comm.StatusEventArgs e)

\{

Status status = e.GetStatus();

}

The status is obtained from the event’s *StatusEventArgs*.

*PalmSens.Core:*

comm.ReceiveStatus += Comm_ReceiveStatus;

To get the device’s status updates subscribe to the *CommManager’s
ReceiveStatus* event after connecting to a device. (*comm* is a
reference to the instance of the *CommManager* created when connecting
to a device).

private void Comm_ReceiveStatus(object sender, StatusEventArgs e)

\{

Status status = e.GetStatus();

}

The status is obtained from the event’s *StatusEventArgs*.

=== Manually controlling the device

Depending on your device’s capabilities it can be used to set a
potential/current and to switch current ranges. The potential can be set
manually in potentiostatic mode and the current can be set in
galvanostatic mode. The following examples show how to manually set a
potential.

*Simplfied PalmSens.Core:*

psCommSimpleWinForms.SetCellPotential(1f);

psCommSimpleWinForms.TurnCellOn();

The psCommSimpleWinforms component must be connected to a device before
you can set its potential and control the cell. To turn the cell off
call *psCommSimpleWinForms.TurnCellOff()*.

*PalmSens.Core:*

comm.Potential = 1f;

comm.CellOn = true;

The device can be controlled using the CommManager that was created when
connecting to the device. When the cell is off no potential will be set.
(*comm* is a reference to the instance of the *CommManager* created when
connecting to a device).

____
*Device Capabilities*

The capabilities of a connected device can either accessed via the
*CommManager.Capabilities* or the *psCommSimpleWinForms.Capabilities*
property. The *DeviceCapabilities* contains properties such as its
maximum potential, supported current ranges and support for specific
features (galvanostat/impedance/bipot). The *DeviceCapabilities* can
also be used to determine whether a certain method is compatible with a
device using either *method.Validate(DeviceCapabilities)* or
*psCommSimpleWinforms.ValidateMethod(method)*.
____
